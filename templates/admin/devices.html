{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Connected Devices</h2>
    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary">Back to Dashboard</a>
</div>

<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">All Devices</h5>
            <span class="badge bg-primary">{{ devices|length }} devices</span>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="devices-table">
                <thead>
                    <tr>
                        <th>Device Name</th>
                        <th>MAC Address</th>
                        <th>IP Address</th>
                        <th>Status</th>
                        <th>Last Seen</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for device in devices %}
                        <tr>
                            <td>{{ device.device_name or 'Unknown' }}</td>
                            <td>{{ device.mac_address }}</td>
                            <td>{{ device.ip_address or 'N/A' }}</td>
                            <td>
                                <span class="device-status {% if device.is_blocked %}blocked{% elif device.is_online %}online{% else %}offline{% endif %}"></span>
                                {% if device.is_blocked %}
                                    Blocked
                                {% elif device.is_online %}
                                    Online
                                {% else %}
                                    Offline
                                {% endif %}
                            </td>
                            <td>{{ device.last_seen.strftime('%Y-%m-%d %H:%M') if device.last_seen else "Never" }}</td>
                            <td>
                                {% if device.is_blocked %}
                                    <button class="btn btn-success btn-sm"
                                            onclick="toggleDevice('{{ device.mac_address }}', 'unblock')">Unblock</button>
                                {% else %}
                                    <button class="btn btn-danger btn-sm"
                                            onclick="toggleDevice('{{ device.mac_address }}', 'block')">Block</button>
                                {% endif %}
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="6" class="text-center">No devices found</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- AJAX Script -->
<script>
async function toggleDevice(mac, action) {
    let url = `/api/${action}_device/${mac}`;
    try {
        let response = await fetch(url, { method: "POST" });
        let result = await response.json();
        if (result.status === "success") {
            alert(result.message);
            location.reload(); // Refresh table to show updated status
        } else {
            alert("Failed: " + result.message);
        }
    } catch (err) {
        alert("Error: " + err);
    }
}
</script>
{% endblock %}
